<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>시스템 관리 | Family Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .scale-in { animation: scaleIn 0.2s ease-out; }
        @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* 테이블 반응형 핵심: 모바일에서는 숨기고 카드로 대체하거나 스크롤 허용 */
        @media (max-width: 768px) {
            .admin-table thead { display: none; }
            .admin-table tr { display: block; margin-bottom: 1rem; border: 1px solid #f1f5f9; border-radius: 1.5rem; background: white; padding: 1rem; }
            .admin-table td { display: flex; justify-content: justify; padding: 0.5rem 0 !important; border: none !important; width: 100%; text-align: left !important; }
            .admin-table td::before { content: attr(data-label); font-weight: 700; width: 100px; color: #94a3b8; font-size: 0.75rem; shrink: 0; }
        }
    </style>
</head>
<body class="min-h-screen pb-10">

    <nav class="bg-white border-b border-gray-200 px-4 md:px-8 py-4 flex justify-between items-center sticky top-0 z-40">
        <div class="flex items-center gap-2">
            <a href="/home" class="text-blue-600 hover:text-blue-700 transition">
                <i data-lucide="arrow-left" class="w-5 h-5 md:w-6 md:h-6"></i>
            </a>
            <h1 class="text-lg md:text-xl font-bold text-gray-800">Admin</h1>
        </div>
        <div class="flex items-center gap-3 md:gap-4">
            <span class="text-xs md:text-sm font-medium text-gray-500 hidden sm:inline" th:text="${adminNickname + '님'}">관리자님</span>
            <div class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs font-bold">AD</div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-8">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-8 mb-8 md:cl-12">
            
            <div class="bg-white rounded-3xl p-6 md:p-8 shadow-sm border border-gray-100 lg:col-span-2">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-base md:text-lg font-bold text-gray-800">시스템 스토리지 요약</h2>
                        <p class="text-[10px] md:text-xs text-gray-400" th:text="'실제 사용량: ' + ${systemUsed} + ' / ' + ${systemQuota} + ' GB'"></p>
                    </div>
                    <div class="text-right">
                        <span class="text-2xl md:text-3xl font-black text-blue-600" th:text="${systemPercent + '%'}">0%</span>
                    </div>
                </div>

                <div class="w-full bg-gray-100 h-3 md:h-4 rounded-full overflow-hidden mb-6">
                    <div class="bg-blue-600 h-full transition-all duration-1000" th:style="'width:' + ${systemPercent} + '%'"></div>
                </div>

                <div class="pt-4 border-t border-gray-50">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-[10px] md:text-xs font-bold text-gray-500 uppercase">권한 할당 합계</h3>
                        <span class="text-[10px] md:text-xs font-bold" th:classappend="${allocationPercent > 90 ? 'text-red-500' : 'text-gray-700'}"
                              th:text="${totalAllocated + ' / ' + systemQuota + ' GB (' + allocationPercent + '%)'}"></span>
                    </div>
                    <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden mb-6">
                        <div class="h-full transition-all duration-500" 
                             th:classappend="${allocationPercent > 90 ? 'bg-red-500' : (allocationPercent > 75 ? 'bg-orange-500' : 'bg-green-500')}"
                             th:style="'width:' + ${allocationPercent} + '%'"></div>
                    </div>
                </div>

                <form action="/admin/update-system-quota" method="post" class="flex flex-wrap items-center gap-3">
                    <div class="flex items-end gap-1">
                        <input type="number" name="quota" th:value="${systemQuota}" 
                               class="text-lg md:text-xl font-bold text-gray-800 outline-none w-20 border-b-2 border-blue-500 bg-transparent">
                        <span class="font-bold text-gray-400 pb-1 text-sm md:text-base">GB</span>
                    </div>
                    <button type="submit" class="bg-gray-800 hover:bg-black text-white px-4 py-2 rounded-xl font-bold text-[10px] md:text-xs transition">시스템 용량 수정</button>
                </form>
            </div>

            <div class="grid grid-cols-2 lg:grid-cols-1 gap-4">
                <div class="bg-white p-5 md:p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] md:text-xs font-medium text-gray-400 mb-1 leading-none">가족 구성원</p>
                        <span class="text-xl md:text-2xl font-bold text-gray-800" th:text="${userCount + ' 명'}">0 명</span>
                    </div>
                    <div class="p-2 md:p-3 bg-purple-50 text-purple-600 rounded-xl md:rounded-2xl shrink-0"><i data-lucide="user-check" class="w-5 h-5"></i></div>
                </div>
                <div class="bg-white p-5 md:p-6 rounded-3xl shadow-sm border border-gray-100 flex items-center justify-between">
                    <div>
                        <p class="text-[10px] md:text-xs font-medium text-gray-400 mb-1 leading-none">총 파일 수</p>
                        <span class="text-xl md:text-2xl font-bold text-gray-800" th:text="${fileCount + ' 개'}">0 개</span>
                    </div>
                    <div class="p-2 md:p-3 bg-green-50 text-green-600 rounded-xl md:rounded-2xl shrink-0"><i data-lucide="file-text" class="w-5 h-5"></i></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-3xl shadow-sm border border-gray-100 overflow-hidden">
            <div class="p-6 md:p-8 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <h3 class="text-lg md:text-xl font-bold text-gray-800">가족 계정 관리</h3>
                <button onclick="openModal()" class="w-full sm:w-auto text-xs bg-blue-600 text-white hover:bg-blue-700 px-5 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                    <i data-lucide="plus" class="w-4 h-4"></i> 구성원 초대
                </button>
            </div>
            
            <div class="p-4 md:p-0 overflow-x-auto">
                <table class="admin-table w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-50/50">
                            <th class="px-8 py-4 text-xs font-bold text-gray-400 uppercase">구성원 / 아이디</th>
                            <th class="px-8 py-4 text-xs font-bold text-gray-400 uppercase text-center">파일 수</th>
                            <th class="px-8 py-4 text-xs font-bold text-gray-400 uppercase">용량 사용량</th>
                            <th class="px-8 py-4 text-xs font-bold text-gray-400 uppercase text-center">할당량 수정</th>
                            <th class="px-8 py-4 text-xs font-bold text-gray-400 uppercase text-center">관리</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-50">
                        <tr th:each="uMap : ${users}" class="hover:bg-gray-50/50 transition">
                            <td class="px-8 py-5" data-label="구성원">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold text-sm" 
                                         th:text="${#strings.substring(uMap.info.userName, 0, 1)}">U</div>
                                    <div>
                                        <div class="font-bold text-sm md:text-base text-gray-800">
                                            <span th:text="${uMap.info.userName}">이름</span>
                                            <span th:if="${uMap.info.userRole == 10}" class="ml-1 px-1.5 py-0.5 bg-blue-50 text-[8px] md:text-[9px] text-blue-500 rounded font-bold uppercase">Family</span>
                                        </div>
                                        <div class="text-[10px] md:text-xs text-gray-400" th:text="${uMap.info.userId}">ID</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-8 py-5 text-center font-medium text-gray-600 text-sm md:text-base" data-label="파일 수" th:text="${uMap.fileCount + '개'}">0개</td>
                            <td class="px-8 py-5" data-label="용량 현황">
                                <div class="flex flex-col gap-1.5 w-full md:w-48">
                                    <div class="flex justify-between text-[10px] font-bold">
                                        <span class="text-blue-600" th:text="${uMap.used + ' GB'}">0 GB</span>
                                        <span class="text-gray-400" th:text="${uMap.info.cloudSize + ' GB'}">20 GB</span>
                                    </div>
                                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                                        <div class="bg-blue-400 h-full" th:style="'width:' + ${uMap.percent} + '%'"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-8 py-5 text-center" data-label="할당량 수정">
                                <form th:action="@{/admin/update-user-quota}" method="post" class="flex items-center justify-start md:justify-center gap-2">
                                    <input type="hidden" name="userId" th:value="${uMap.info.userId}">
                                    <input type="number" name="sz" th:value="${uMap.info.cloudSize}" 
                                           class="w-14 md:w-16 p-1.5 bg-white border border-gray-200 rounded-lg text-center font-bold text-gray-700 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                                    <button type="submit" class="p-1.5 text-blue-600 hover:bg-blue-50 rounded-lg transition shrink-0">
                                        <i data-lucide="save" class="w-5 h-5"></i>
                                    </button>
                                </form>
                            </td>
                            <td class="px-8 py-5 text-center" data-label="계정 관리">
                                <div th:if="${uMap.info.userRole == 10 || uMap.info.userRole == 100 || uMap.info.userId == 'admin'}" 
                                     class="flex justify-start md:justify-center items-center gap-1 text-gray-300">
                                    <i data-lucide="lock" class="w-3 h-3 md:w-4 md:h-4"></i>
                                    <span class="text-[8px] md:text-[10px] font-bold uppercase">Fixed</span>
                                </div>
                                <a th:unless="${uMap.info.userRole == 10 || uMap.info.userRole == 100 || uMap.info.userId == 'admin'}" 
                                   th:href="@{/admin/delete-user(id=${uMap.info.userId})}" 
                                   class="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition inline-block" 
                                   onclick="return confirm('정말 삭제하시겠습니까? 데이터가 모두 삭제됩니다.')">
                                    <i data-lucide="user-minus" class="w-5 h-5"></i>
                                </a>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center p-4 z-50 backdrop-blur-sm">
        <div class="bg-white rounded-3xl max-w-md w-full p-6 md:p-8 shadow-2xl scale-in overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl md:text-2xl font-bold text-gray-800 mb-6">새 구성원 추가</h3>
            <form action="/createac" method="post" class="space-y-4 md:space-y-5">
                <div>
                    <label class="block text-xs md:text-sm font-bold text-gray-700 mb-2">닉네임</label>
                    <input name="nm" type="text" required placeholder="예: 엄마" 
                           class="w-full p-3 md:p-4 bg-gray-50 border border-transparent rounded-2xl outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition text-sm">
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-bold text-gray-700 mb-2">아이디</label>
                    <input name="id" type="text" required placeholder="로그인 아이디" 
                           class="w-full p-3 md:p-4 bg-gray-50 border border-transparent rounded-2xl outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition text-sm">
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-bold text-gray-700 mb-2">비밀번호</label>
                    <input name="pw" type="password" required placeholder="비밀번호" 
                           class="w-full p-3 md:p-4 bg-gray-50 border border-transparent rounded-2xl outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition text-sm">
                </div>
                <div>
                    <label class="block text-xs md:text-sm font-bold text-gray-700 mb-2">초기 할당 용량 (GB)</label>
                    <input name="sz" type="number" value="20" min="1" 
                           class="w-full p-3 md:p-4 bg-gray-50 border border-transparent rounded-2xl outline-none focus:bg-white focus:ring-2 focus:ring-blue-500 transition font-bold text-blue-600 text-sm">
                </div>
                <div class="flex gap-3 md:gap-4 mt-6 md:mt-8">
                    <button type="button" onclick="closeModal()" class="flex-1 py-3 md:py-4 bg-gray-100 text-gray-500 font-bold rounded-2xl text-sm transition">취소</button>
                    <button type="submit" class="flex-1 py-3 md:py-4 bg-blue-600 text-white font-bold rounded-2xl text-sm transition">생성</button>
                </div>
            </form>
        </div>
    </div>

    <script th:if="${error}">
        alert([[${error}]]);
    </script>
    <script>
        lucide.createIcons();
        function openModal() { document.getElementById('modal').classList.replace('hidden', 'flex'); }
        function closeModal() { document.getElementById('modal').classList.replace('flex', 'hidden'); }
    </script>
</body>
</html>